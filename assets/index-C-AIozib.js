(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();class f{scene;baseTarget;towerTarget;enemies=new Map;enemyIdCounter=0;spawnInterval=null;gameLoop=null;health=100;points=0;gameOver=!1;gameWon=!1;healthElement=null;pointsElement=null;waveElement=null;waveStartIndicator=null;waveStartIndicatorTimeout=null;upgradeScreen=null;blurElement=null;upgradePointsElement=null;restartButton=null;upgradeListElement=null;winPopup=null;winBlur=null;winRestartButton=null;winResetButton=null;winAttemptsElement=null;shopVisits=0;SHOP_VISITS_STORAGE_KEY="td_shop_visits";mindarLoadingOverlay=null;mindarScanningOverlay=null;mindarErrorOverlay=null;mindarTrackedCount=0;MOVEMENT_THRESHOLD=.3;STABILITY_BASE_TIME=3e3;towerStabilityTimeMs=this.STABILITY_BASE_TIME;towerLostTimes=new Map;TOWER_LOST_GRACE_PERIOD=100;towerTrackedTargets=new WeakSet;towerListenerTargets=new WeakSet;TOWER_BASE_RANGE=700;TOWER_BASE_RADIUS=.7;towerFireRateMs=2e3;towerRange=this.TOWER_BASE_RANGE;towers=[];defaultBaseHealth=100;pointMultiplier=1;SPAWN_DISTANCE=5;MIN_SPAWN_TIME=10;GAME_Z_PLANE=0;spawnCount=0;spawnCenterAngle=0;currentWave=0;totalWaves=10;waveActive=!1;wavePaused=!1;enemiesSpawnedInWave=0;waveBreakDuration=5e3;pausedWaveConfig=null;pausedWaveCompleted=!1;waveConfig=[{count:5,baseSpeed:.5,spreadAngle:10,duration:6e3},{count:10,baseSpeed:.5,spreadAngle:30,duration:8e3},{count:15,baseSpeed:.75,spreadAngle:90,duration:1e4},{count:30,baseSpeed:1,spreadAngle:120,duration:1e4},{count:50,baseSpeed:1.2,spreadAngle:150,duration:1e4},{count:100,baseSpeed:1.5,spreadAngle:180,duration:12e3},{count:200,baseSpeed:2,spreadAngle:270,duration:12e3},{count:500,baseSpeed:2.5,spreadAngle:300,duration:15e3},{count:1e3,baseSpeed:3,spreadAngle:360,duration:2e4},{count:5e3,baseSpeed:4,spreadAngle:360,duration:3e4}];UPGRADE_STORAGE_KEY="td_upgrades";POINTS_STORAGE_KEY="td_points";upgradeDefs=[{id:"tower-count",name:"Tower Count",desc:"Add an additional tower",levels:[{value:1,cost:0},{value:2,cost:100},{value:3,cost:1e3}],format:e=>`${e}`},{id:"range",name:"Tower Range",desc:"Increase tower attack range",levels:[{value:1,cost:0},{value:1.2,cost:5},{value:1.5,cost:10},{value:2,cost:25},{value:3,cost:100}],format:e=>`x${e.toFixed(1)}`},{id:"fire-rate",name:"Tower Fire Rate",desc:"Reduce shooting cooldown",levels:[{value:2e3,cost:0},{value:1800,cost:5},{value:1500,cost:10},{value:1200,cost:20},{value:1e3,cost:50},{value:800,cost:100},{value:500,cost:150},{value:300,cost:250},{value:200,cost:500},{value:100,cost:1e3}],format:e=>`${Math.round(e)}ms`},{id:"rebuild-speed",name:"Rebuild Speed",desc:"Towers stabilize faster after moving",levels:[{value:3e3,cost:0},{value:2e3,cost:5},{value:1500,cost:10},{value:1e3,cost:20},{value:500,cost:50}],format:e=>`${Math.round(e)}ms`},{id:"base-health",name:"Base Health",desc:"Increase base max health",levels:[{value:100,cost:0},{value:150,cost:10},{value:200,cost:20},{value:300,cost:30},{value:500,cost:50},{value:1e3,cost:100}],format:e=>`${e}`},{id:"wave-skip",name:"Wave Skip",desc:"Start new runs on a later wave",levels:[{value:1,cost:0},{value:2,cost:25},{value:3,cost:100},{value:4,cost:250},{value:5,cost:1e3}],format:e=>`Wave ${e}`}];upgradeState={};constructor(){this.init()}init(){this.showDesktopPopupIfNeeded(),document.addEventListener("DOMContentLoaded",()=>{this.scene=document.querySelector("a-scene"),this.mindarLoadingOverlay=document.getElementById("custom-loading"),this.mindarScanningOverlay=document.getElementById("custom-scanning"),this.mindarErrorOverlay=document.getElementById("custom-error"),this.setupMindarOverlayUi(),this.healthElement=document.getElementById("health-value"),this.pointsElement=document.getElementById("energy-value"),this.waveElement=document.getElementById("wave-value"),this.waveStartIndicator=document.getElementById("wave-start-indicator"),this.upgradeScreen=document.getElementById("upgrade-screen"),this.blurElement=document.getElementById("blur"),this.upgradePointsElement=document.getElementById("upgrade-energy"),this.upgradeListElement=document.getElementById("upgrade-list"),this.restartButton=document.getElementById("restart-btn"),this.winPopup=document.getElementById("win-popup"),this.winBlur=document.getElementById("win-blur"),this.winResetButton=document.getElementById("win-reset-btn"),this.winAttemptsElement=document.getElementById("win-attempts"),this.restartButton&&this.restartButton.addEventListener("click",()=>{this.restartGame()}),this.winRestartButton&&this.winRestartButton.addEventListener("click",()=>{this.hideWinPopup(),this.restartGame()}),this.winResetButton&&this.winResetButton.addEventListener("click",()=>{this.resetAllProgress()});const e=document.getElementById("help-btn"),t=document.getElementById("help-popup"),s=document.getElementById("close-help"),i=document.getElementById("help-blur"),a=document.getElementById("help-reset-btn");e&&t&&e.addEventListener("click",()=>{t.style.display="flex",i&&(i.style.display="block")}),s&&t&&s.addEventListener("click",()=>{t.style.display="none",i&&(i.style.display="none")}),i&&t&&i.addEventListener("click",()=>{t.style.display="none",i.style.display="none"}),a&&a.addEventListener("click",()=>{this.resetAllProgress()}),this.loadUpgradeState(),this.loadPoints(),this.loadShopVisits(),this.applyUpgradeEffects(),this.initializeTowersFromUpgrades(),this.registerTowerEventListeners(),this.scene.hasLoaded?this.setupGame():this.scene.addEventListener("loaded",()=>{this.setupGame()})})}setMindarOverlayVisible(e,t){e&&(e.style.display=t?"flex":"none")}showMindarOverlay(e){this.setMindarOverlayVisible(this.mindarLoadingOverlay,e==="loading"),this.setMindarOverlayVisible(this.mindarScanningOverlay,e==="scanning"),this.setMindarOverlayVisible(this.mindarErrorOverlay,e==="error")}setupMindarOverlayUi(){if(this.showMindarOverlay("loading"),!this.scene)return;this.scene.addEventListener("arReady",()=>{this.mindarTrackedCount=0,this.showMindarOverlay("scanning")},{once:!0}),this.scene.addEventListener("arError",()=>{this.showMindarOverlay("error")}),Array.from(document.querySelectorAll("[mindar-image-target]")).forEach(t=>{t.addEventListener("targetFound",()=>{this.mindarTrackedCount+=1,this.showMindarOverlay("none")}),t.addEventListener("targetLost",()=>{this.mindarTrackedCount=Math.max(0,this.mindarTrackedCount-1),this.mindarTrackedCount===0&&this.showMindarOverlay("scanning")})})}showDesktopPopupIfNeeded(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t=document.getElementById("desktop-popup"),s=document.getElementById("close-popup"),i=t?.querySelector("#blur");!e&&t&&(t.style.display="flex",i&&(i.style.display="block"),s&&s.addEventListener("click",()=>{t.style.display="none",i&&(i.style.display="none")}),i&&i.addEventListener("click",()=>{t.style.display="none",i.style.display="none"}))}setupGame(){if(this.baseTarget=document.querySelector('[mindar-image-target="targetIndex: 0"]'),this.towerTarget=document.querySelector('[mindar-image-target="targetIndex: 1"]'),!this.baseTarget||!this.towerTarget){console.error("Could not find base or tower targets");return}this.baseTarget.addEventListener("targetFound",()=>{this.startEnemySpawning()}),this.baseTarget.addEventListener("targetLost",()=>{this.stopEnemySpawning(!1)}),this.startGameLoop()}registerTowerEventListeners(){this.towers.forEach(e=>{this.towerListenerTargets.has(e.target)||(this.towerListenerTargets.add(e.target),e.target.addEventListener("targetFound",()=>{this.towerTrackedTargets.add(e.target),this.towerLostTimes.delete(e.target),e.isMoving=!0,e.lastMovementTime=0,e.homePosition=null,e.lastPosition=null,this.setupTowerVisualsForTower(e)}),e.target.addEventListener("targetLost",()=>{this.towerTrackedTargets.delete(e.target),this.towerLostTimes.set(e.target,Date.now()),this.handleTowerLostForTower(e)}))})}forceTrackedTowersIntoBuildingState(){this.towers.forEach(e=>{e.target?.object3D?.visible&&this.towerTrackedTargets.has(e.target)&&(this.towerLostTimes.delete(e.target),e.isMoving=!0,e.lastMovementTime=0,e.homePosition=null,e.lastPosition=null,e.lastShotTime=0,this.setupTowerVisualsForTower(e))})}startEnemySpawning(){this.gameWon||(this.wavePaused&&this.currentWave>0?(this.wavePaused=!1,this.waveActive=!0,this.resumeWave()):this.currentWave===0&&(this.currentWave=this.getStartingWaveForNewGame(),this.startWave()))}getStartingWaveForNewGame(){const e=Math.round(this.getUpgradeCurrentValueById("wave-skip"));return Math.max(1,Math.min(this.totalWaves,e))}initializeTowersFromUpgrades(){const t=1+(this.upgradeState["tower-count"]??0),s=new Map;this.towers.forEach(n=>s.set(n.target,n));const i=Array.from(document.querySelectorAll("a-entity.tower"));i.forEach((n,r)=>{const o=n;r<t?(o.setAttribute("visible","true"),o.object3D&&(o.object3D.visible=!0),n.querySelectorAll("*").forEach(l=>{l.setAttribute("visible","true"),l.object3D&&(l.object3D.visible=!0)}),n.hasAttribute("mindar-image-target")||o.setAttribute("mindar-image-target",`targetIndex: ${r+1}`)):(o.setAttribute("visible","false"),o.object3D&&(o.object3D.visible=!1),n.querySelectorAll("*").forEach(l=>{l.setAttribute("visible","false"),l.object3D&&(l.object3D.visible=!1)}),o.removeAttribute("mindar-image-target"))});const a=i.slice(0,t);this.towers=a.map(n=>{const r=s.get(n);return r?(r.sphere=null,r.circle=null,r.movingText=null,r.buildRing=null,r.homePosition=null,r.lastPosition=null,r.isMoving=!1,r.lastMovementTime=0,r.lastShotTime=0,r.fireRateMs=this.towerFireRateMs,r.range=this.towerRange,r):{target:n,sphere:null,circle:null,movingText:null,buildRing:null,homePosition:null,lastPosition:null,isMoving:!1,lastMovementTime:0,lastShotTime:0,fireRateMs:this.towerFireRateMs,range:this.towerRange}})}reinitializeTowersAfterUpgrades(){this.towers.forEach(e=>{if(this.setTowerActiveForTower(e,!1),e.movingText){try{e.target.removeChild(e.movingText)}catch{}e.movingText=null}if(e.buildRing){try{e.target.removeChild(e.buildRing)}catch{}e.buildRing=null}}),this.applyUpgradeEffects(),this.initializeTowersFromUpgrades(),this.registerTowerEventListeners()}resumeWave(){if(!this.pausedWaveConfig||this.currentWave===0)return;const e=this.pausedWaveConfig,t=Math.max(this.MIN_SPAWN_TIME,Math.round(e.duration/e.count)),s=this.pausedWaveCompleted;this.spawnInterval=window.setInterval(()=>{!this.waveActive||s||(this.enemiesSpawnedInWave<e.count?this.spawnEnemy():(clearInterval(this.spawnInterval),this.spawnInterval=null,this.waveActive=!1,this.pausedWaveConfig=null,this.currentWave<this.totalWaves&&setTimeout(()=>{this.currentWave++,this.startWave()},this.waveBreakDuration)))},t)}startWave(){if(this.currentWave>this.totalWaves||this.gameOver)return;const e=this.waveConfig[this.currentWave-1];this.waveActive=!0,this.enemiesSpawnedInWave=0,this.wavePaused=!1,this.pausedWaveCompleted=!1,this.pausedWaveConfig=e,this.spawnCenterAngle=Math.random()*Math.PI*2,this.spawnInterval&&clearInterval(this.spawnInterval);const t=Math.max(this.MIN_SPAWN_TIME,Math.round(e.duration/e.count));setTimeout(()=>{this.updateWaveDisplay(),this.showWaveStartIndicator()},2e3/e.baseSpeed);let s=!1;this.spawnInterval=window.setInterval(()=>{if(this.wavePaused){clearInterval(this.spawnInterval),this.spawnInterval=null,this.pausedWaveCompleted=s;return}!this.waveActive||s||(this.enemiesSpawnedInWave<e.count?this.spawnEnemy():s||(s=!0,clearInterval(this.spawnInterval),this.spawnInterval=null,this.waveActive=!1,this.pausedWaveConfig=null,this.currentWave<this.totalWaves&&setTimeout(()=>{this.currentWave++,this.startWave()},this.waveBreakDuration)))},t)}stopEnemySpawning(e=!0){this.spawnInterval&&(clearInterval(this.spawnInterval),this.spawnInterval=null),e?(this.spawnCount=0,this.currentWave=0,this.waveActive=!1,this.wavePaused=!1,this.enemiesSpawnedInWave=0,this.pausedWaveConfig=null):(this.waveActive=!1,this.wavePaused=!0)}spawnEnemy(){if(this.gameOver||!this.waveActive||this.wavePaused||!this.isBaseVisible())return;const e=`enemy-${this.enemyIdCounter++}`,t=document.createElement("a-sphere");t.setAttribute("id",e),t.setAttribute("radius","0.05"),t.setAttribute("color","#CCFF33"),t.setAttribute("roughness","1");const s=this.waveConfig[this.currentWave-1],i=s.spreadAngle*Math.PI/180,a=this.computeSpawnAngle(i),n=Math.cos(a)*this.SPAWN_DISTANCE,r=Math.sin(a)*this.SPAWN_DISTANCE;t.setAttribute("position",`${n} ${r} ${this.GAME_Z_PLANE}`),this.baseTarget.appendChild(t);const o=s.baseSpeed,l={id:e,entity:t,targetPosition:{x:0,y:0},speed:o,health:1};this.enemies.set(e,l),this.spawnCount++,this.enemiesSpawnedInWave++}computeSpawnAngle(e){if(e>=Math.PI*2-.001)return Math.random()*Math.PI*2;const t=(Math.random()-.5)*e;return this.spawnCenterAngle+t}updateTowerCooldownIndicators(){const e=Date.now();this.towers.forEach(t=>{if(!t.sphere)return;const s=e-t.lastShotTime;if(s<t.fireRateMs){const i=Math.max(0,Math.min(1,s/t.fireRateMs)),r=this.lerpColorHex("#330066","#6600FF",i);t.sphere.setAttribute("color",r)}else t.sphere.setAttribute("color","#6600FF")})}lerpColorHex(e,t,s){const i=e.replace(/^#/,""),a=t.replace(/^#/,""),n=parseInt(i.substring(0,2),16),r=parseInt(i.substring(2,4),16),o=parseInt(i.substring(4,6),16),l=parseInt(a.substring(0,2),16),g=parseInt(a.substring(2,4),16),p=parseInt(a.substring(4,6),16),d=Math.round(n+(l-n)*s),c=Math.round(r+(g-r)*s),u=Math.round(o+(p-o)*s),h=v=>v.toString(16).padStart(2,"0");return`#${h(d)}${h(c)}${h(u)}`}isBaseVisible(){return this.baseTarget&&this.baseTarget.object3D&&this.baseTarget.object3D.visible}startGameLoop(){const e=()=>{this.updateTowerCooldownIndicators(),this.updateEnemies(),this.gameLoop=requestAnimationFrame(e)};e()}updateEnemies(){if(this.gameOver||!this.isBaseVisible())return;const e=1/60;this.towers.forEach(t=>{this.isTowerVisible(t)&&this.isBaseVisible()&&this.checkTowerMovementForTower(t),this.checkTowerAttacksForTower(t)}),this.enemies.forEach((t,s)=>{const i=t.entity.getAttribute("position"),a={x:t.targetPosition.x-i.x,y:t.targetPosition.y-i.y},n=Math.sqrt(a.x**2+a.y**2);if(n<.2){this.takeDamage(10),this.destroyEnemy(s);return}const r={x:a.x/n,y:a.y/n},o={x:i.x+r.x*t.speed*e,y:i.y+r.y*t.speed*e,z:this.GAME_Z_PLANE};t.entity.setAttribute("position",`${o.x} ${o.y} ${o.z}`)}),this.checkWinCondition()}destroyEnemy(e){const t=this.enemies.get(e);t&&(t.entity.parentNode&&t.entity.parentNode.removeChild(t.entity),this.enemies.delete(e)),this.checkWinCondition()}isTowerVisible(e){if(!e.target||!this.towerTrackedTargets.has(e.target)||!e.target.object3D||!e.target.object3D.visible)return!1;const t=this.towerLostTimes.get(e.target);return!(t&&Date.now()-t<this.TOWER_LOST_GRACE_PERIOD)}isTowerReadyToAttack(e){return!(!this.isTowerVisible(e)||!e.homePosition||e.isMoving)}getMarkerWorldPosition(e){if(!e||!e.object3D)return null;const t=e.object3D.getWorldPosition(new window.THREE.Vector3);return{x:t.x,y:t.y}}checkTowerAttacksForTower(e){if(!this.isTowerReadyToAttack(e))return;const t=Date.now();if(t-e.lastShotTime<e.fireRateMs)return;const s=this.getMarkerWorldPosition(e.target);if(!s)return;let i=null,a=Number.POSITIVE_INFINITY;if(this.enemies.forEach((n,r)=>{const o=this.getEnemyWorldPosition(n);if(o){const l=this.calculateDistance2D(s,o);l<=e.range&&l<a&&(a=l,i=r)}}),i){const n=this.enemies.get(i);n&&(this.createAttackLineFromTower(n,e),this.addPoints(1),this.destroyEnemy(i),e.lastShotTime=t)}}getEnemyWorldPosition(e){if(!e.entity||!e.entity.object3D)return null;const t=e.entity.object3D.getWorldPosition(new window.THREE.Vector3);return{x:t.x,y:t.y}}calculateDistance2D(e,t){const s=t.x-e.x,i=t.y-e.y;return Math.sqrt(s*s+i*i)}createAttackLineFromTower(e,t){const s=e.entity.getAttribute("position"),i=this.getTowerPositionForTower(t);if(!i||!this.isTowerReadyToAttack(t))return;const a=document.createElement("a-entity"),n=Math.sqrt((s.x-i.x)**2+(s.y-i.y)**2),r=Math.atan2(s.y-i.y,s.x-i.x),o={x:(i.x+s.x)/2,y:(i.y+s.y)/2,z:this.GAME_Z_PLANE+.01};a.setAttribute("geometry",`primitive: cylinder; radius: 0.005; height: ${n}`),a.setAttribute("material","color: #F8349B; opacity: 0.5"),a.setAttribute("position",`${o.x} ${o.y} ${o.z}`),a.setAttribute("rotation",`0 0 ${r*180/Math.PI-90}`),this.baseTarget.appendChild(a),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},100)}setupTowerVisualsForTower(e){if(e.target){if(e.sphere=e.target.querySelector("a-sphere")||e.target.querySelector("a-box")||e.target.querySelector("a-cone")||e.target.querySelector("a-tetrahedron"),e.circle=e.target.querySelector("a-circle"),e.circle){const t=this.towerRange/this.TOWER_BASE_RANGE,s=this.TOWER_BASE_RADIUS*t;e.circle.setAttribute("radius",s.toString()),e.circle.setAttribute("opacity","0.2"),e.circle.setAttribute("visible","true"),e.isMoving&&e.circle.setAttribute("color","#000000")}this.setTowerActiveForTower(e,!1)}}handleTowerLostForTower(e){if(e.movingText&&e.target)try{e.target.removeChild(e.movingText)}catch{}if(e.buildRing&&e.target)try{e.target.removeChild(e.buildRing)}catch{}e.isMoving=!0,this.resetTowerStateForTower(e)}resetTowerStateForTower(e){e.sphere=null,e.circle=null,e.movingText=null,e.buildRing=null,e.homePosition=null,e.lastPosition=null,e.lastMovementTime=Date.now()}checkTowerMovementForTower(e){const t=this.getTowerPositionForTower(e);if(!t)return;const s=Date.now();if(!e.homePosition){if(!e.sphere||!e.circle)return;e.homePosition={...t},e.lastMovementTime=s;return}const i=this.calculateDistance2D(e.homePosition,t);let a=0;if(e.lastPosition&&(a=this.calculateDistance2D(e.lastPosition,t)),i>this.MOVEMENT_THRESHOLD&&!e.isMoving&&(e.isMoving=!0,this.setTowerActiveForTower(e,!1),e.circle&&e.circle.setAttribute("color","#000000"),e.lastMovementTime=0),e.isMoving){if(e.circle||(e.circle=e.target.querySelector("a-circle")),e.circle){e.circle.setAttribute("color","#000000");const n=this.towerRange/this.TOWER_BASE_RANGE,r=this.TOWER_BASE_RADIUS*n;e.circle.setAttribute("radius",r.toString())}if(a<=.1){e.lastMovementTime===0&&(e.lastMovementTime=s);const n=s-e.lastMovementTime,r=this.towerStabilityTimeMs-n;if(n>=this.towerStabilityTimeMs)e.homePosition={...t},e.isMoving=!1,e.circle&&e.circle.setAttribute("color","#6600FF"),this.setTowerActiveForTower(e,!0),e.lastMovementTime=0;else{const o=Math.ceil(100-r/this.towerStabilityTimeMs*100);this.updateMovingText(o)}}else e.lastMovementTime>0&&(e.lastMovementTime=0)}e.lastPosition={...t}}updateMovingText(e){this.towers.forEach(t=>{if(!t.buildRing)return;const i=(Number.isFinite(e)?Math.max(0,Math.min(100,e)):0)/100*360;t.buildRing.setAttribute("theta-length",i)})}setTowerActiveForTower(e,t){if(e.target)if(e.sphere||(e.sphere=e.target.querySelector("a-sphere")||e.target.querySelector("a-box")||e.target.querySelector("a-cone")||e.target.querySelector("a-tetrahedron")),t){if(e.sphere&&(e.sphere.setAttribute("visible","true"),e.sphere.setAttribute("opacity","1")),e.circle&&!e.isMoving&&e.circle.setAttribute("color","#6600FF"),e.movingText&&(e.target.removeChild(e.movingText),e.movingText=null),e.buildRing){try{e.target.removeChild(e.buildRing)}catch{}e.buildRing=null}}else e.sphere&&(e.sphere.setAttribute("visible","false"),e.sphere.setAttribute("opacity","0")),e.circle&&!e.isMoving&&e.circle.setAttribute("color","#330066"),e.buildRing||(e.buildRing=document.createElement("a-ring"),e.buildRing.setAttribute("position","0 0 0.16"),e.buildRing.setAttribute("radius-inner","0.14"),e.buildRing.setAttribute("radius-outer","0.20"),e.buildRing.setAttribute("theta-start","90"),e.buildRing.setAttribute("theta-length","0"),e.buildRing.setAttribute("material","color: #6600FF; opacity: 0.8; transparent: true; side: double"),e.target.appendChild(e.buildRing))}getTowerPositionForTower(e){if(!this.baseTarget||!e.target||!this.baseTarget.object3D||!e.target.object3D)return null;const t=e.target.object3D.getWorldPosition(new window.THREE.Vector3),s=this.baseTarget.object3D.worldToLocal(t.clone());return{x:s.x,y:s.y}}takeDamage(e){if(!this.gameOver&&(this.health-=e,this.health=Math.max(0,this.health),this.updateHealthDisplay(),this.baseTarget)){const t=this.baseTarget.querySelector("a-icosahedron");t&&(t.setAttribute("color","#F8349B"),setTimeout(()=>{t.setAttribute("color","white")},100)),this.health<=0&&(t?.setAttribute("color","white"),this.endGame())}}addPoints(e){if(this.gameOver)return;const t=Math.round(e*this.pointMultiplier);this.points+=t,this.savePoints(),this.updatePointsDisplay()}updateHealthDisplay(){this.healthElement&&(this.healthElement.textContent=this.health.toString(),this.health<=30?this.healthElement.classList.add("low"):this.healthElement.classList.remove("low"))}updatePointsDisplay(){this.pointsElement&&(this.pointsElement.textContent=this.points.toString()),this.upgradePointsElement&&(this.upgradePointsElement.textContent=this.points.toString())}updateWaveDisplay(){this.waveElement&&(this.waveElement.textContent=this.currentWave.toString())}showWaveStartIndicator(){this.waveStartIndicator&&(this.currentWave<=0||(this.waveStartIndicatorTimeout!==null&&(window.clearTimeout(this.waveStartIndicatorTimeout),this.waveStartIndicatorTimeout=null),this.waveStartIndicator.textContent=`Wave ${this.currentWave}`,this.waveStartIndicator.style.display="block",requestAnimationFrame(()=>{this.waveStartIndicator?.classList.add("show")}),this.waveStartIndicatorTimeout=window.setTimeout(()=>{this.waveStartIndicator&&(this.waveStartIndicator.classList.remove("show"),window.setTimeout(()=>{this.waveStartIndicator&&(this.waveStartIndicator.classList.contains("show")||(this.waveStartIndicator.style.display="none"))},180))},1200)))}checkWinCondition(){if(this.gameWon||!(this.currentWave===this.totalWaves&&this.currentWave>0))return;const t=this.waveConfig[this.totalWaves-1];this.enemiesSpawnedInWave>=t.count&&this.spawnInterval===null&&!this.waveActive&&!this.wavePaused&&this.enemies.size===0&&this.handleWin()}handleWin(){this.gameWon=!0,this.gameOver=!0,this.waveActive=!1,this.wavePaused=!1,this.stopEnemySpawning(!1),this.upgradeScreen&&(this.upgradeScreen.style.display="none"),this.blurElement&&(this.blurElement.style.display="none");const e=this.shopVisits+1;this.winAttemptsElement&&(this.winAttemptsElement.textContent=`Attempts to win: ${e}`),this.winPopup&&(this.winPopup.style.display="flex"),this.winBlur&&(this.winBlur.style.display="block")}endGame(){this.gameOver=!0,this.recordShopVisit(),this.stopEnemySpawning(),this.upgradeScreen&&this.upgradePointsElement&&this.blurElement&&(this.upgradePointsElement.textContent=this.points.toString(),this.upgradeScreen.style.display="block",this.blurElement.style.display="block",this.renderUpgradeUI()),this.towers.forEach(e=>{if(e.movingText){try{e.target.removeChild(e.movingText)}catch{}e.movingText=null}})}restartGame(){this.stopEnemySpawning(!0),this.health=this.defaultBaseHealth,this.gameOver=!1,this.gameWon=!1,this.enemies.forEach((e,t)=>{this.destroyEnemy(t)}),this.enemyIdCounter=0,this.currentWave=0,this.waveActive=!1,this.wavePaused=!1,this.enemiesSpawnedInWave=0,this.spawnCount=0,this.pausedWaveConfig=null,this.pausedWaveCompleted=!1,this.updateHealthDisplay(),this.updatePointsDisplay(),this.updateWaveDisplay(),this.upgradeScreen&&(this.upgradeScreen.style.display="none"),this.blurElement&&(this.blurElement.style.display="none"),this.hideWinPopup(),this.reinitializeTowersAfterUpgrades(),this.forceTrackedTowersIntoBuildingState(),this.baseTarget?.object3D?.visible&&this.startEnemySpawning()}resetAllProgress(){try{window.localStorage.removeItem(this.UPGRADE_STORAGE_KEY),window.localStorage.removeItem(this.POINTS_STORAGE_KEY),window.localStorage.removeItem(this.SHOP_VISITS_STORAGE_KEY)}catch{}window.location.reload()}hideWinPopup(){this.winPopup&&(this.winPopup.style.display="none"),this.winBlur&&(this.winBlur.style.display="none")}loadUpgradeState(){try{const e=window.localStorage.getItem(this.UPGRADE_STORAGE_KEY);if(e){this.upgradeState=JSON.parse(e);let t=!1;this.upgradeDefs.forEach(s=>{this.upgradeState[s.id]===void 0&&(this.upgradeState[s.id]=0,t=!0)}),t&&this.saveUpgradeState()}else this.upgradeState=this.upgradeDefs.reduce((t,s)=>(t[s.id]=0,t),{}),this.saveUpgradeState()}catch{this.upgradeState={},this.upgradeDefs.forEach(e=>this.upgradeState[e.id]=0)}}saveUpgradeState(){try{window.localStorage.setItem(this.UPGRADE_STORAGE_KEY,JSON.stringify(this.upgradeState))}catch{}}loadPoints(){try{const e=window.localStorage.getItem(this.POINTS_STORAGE_KEY);e&&(this.points=parseInt(e,10),this.updatePointsDisplay())}catch{this.points=0}}loadShopVisits(){try{const e=window.localStorage.getItem(this.SHOP_VISITS_STORAGE_KEY);e&&(this.shopVisits=parseInt(e,10)||0)}catch{this.shopVisits=0}}saveShopVisits(){try{window.localStorage.setItem(this.SHOP_VISITS_STORAGE_KEY,this.shopVisits.toString())}catch{}}savePoints(){try{window.localStorage.setItem(this.POINTS_STORAGE_KEY,this.points.toString())}catch{}}recordShopVisit(){this.shopVisits+=1,this.saveShopVisits()}getUpgradeCurrentValueById(e){const t=this.upgradeDefs.find(s=>s.id===e);return t?this.getUpgradeCurrentValue(t):0}applyUpgradeEffects(){const e=this.getUpgradeCurrentValueById("range");this.towerRange=this.TOWER_BASE_RANGE*e,this.towerFireRateMs=this.getUpgradeCurrentValueById("fire-rate"),this.defaultBaseHealth=this.getUpgradeCurrentValueById("base-health");const t=this.getUpgradeCurrentValueById("rebuild-speed");this.towerStabilityTimeMs=Math.max(200,Math.round(t||this.STABILITY_BASE_TIME)),this.towers.forEach(s=>{s.range=this.towerRange,s.fireRateMs=this.towerFireRateMs;const i=this.TOWER_BASE_RADIUS*e;s.circle&&s.circle.setAttribute("radius",i)}),this.health=this.defaultBaseHealth,this.updateHealthDisplay()}getUpgradeCurrentValue(e){const t=this.upgradeState[e.id]??0;return e.levels[Math.min(t,e.levels.length-1)].value}getUpgradeNextValue(e){const t=(this.upgradeState[e.id]??0)+1,s=Math.min(t,e.levels.length-1);return e.levels[s].value}getUpgradeNextCost(e){const t=(this.upgradeState[e.id]??0)+1;return t>=e.levels.length?0:e.levels[t].cost}renderUpgradeUI(){if(!this.upgradeListElement)return;const e=this.upgradeListElement;e.innerHTML="",this.upgradeDefs.forEach(t=>{const s=this.getUpgradeCurrentValue(t),i=this.getUpgradeNextValue(t),a=this.getUpgradeNextCost(t),n=this.upgradeState[t.id]??0,r=n>=t.levels.length-1,o=t.levels.length,l=r?"Max":t.format(i),g=r?"Max":`<span class="material-symbols-rounded icon-bolt-small">bolt</span><span class="cost-value">${a}</span>`;let p='<div class="upgrade-progress">';for(let u=1;u<o;u++){const h=u<=n?"filled":"";p+=`<div class="progress-segment ${h}"></div>`}p+="</div>";const d=document.createElement("div");d.className=r?"upgrade-item maxed":"upgrade-item",d.innerHTML=`
        <div class="upgrade-header">
          <span class="upgrade-name">${t.name}</span>
          <span class="upgrade-cost">${g}</span>
        </div>
        <p class="upgrade-desc">${t.desc}</p>
        <p class="upgrade-level"><span class="level-current">${t.format(s)}</span> <span class="material-symbols-rounded icon-to">arrow_right</span> <span class="level-next">${l}</span></p>
        ${p}
        <button class="upgrade-btn" data-upgrade="${t.id}">Upgrade</button>
      `;const c=d.querySelector(".upgrade-btn");if(c){let u="Upgrade",h=!1;r?(u="Max",h=!0):this.points<a&&(u="Not enough points",h=!0),c.textContent=u,h?c.setAttribute("disabled","true"):c.removeAttribute("disabled"),c.addEventListener("click",()=>{h||this.purchaseUpgrade(t.id,a)})}e.appendChild(d)})}purchaseUpgrade(e,t){if(this.points<t){console.warn(`Not enough energy for ${e}`);return}this.points-=t,this.savePoints(),this.updatePointsDisplay(),this.upgradeState[e]=(this.upgradeState[e]??0)+1,this.saveUpgradeState(),this.applyUpgradeEffects(),this.renderUpgradeUI(),e==="tower-count"&&this.reinitializeTowersAfterUpgrades()}cleanup(){this.spawnInterval&&clearInterval(this.spawnInterval),this.gameLoop&&cancelAnimationFrame(this.gameLoop),this.enemies.forEach((e,t)=>{this.destroyEnemy(t)})}}const y=new f;window.addEventListener("beforeunload",()=>{y.cleanup()});
